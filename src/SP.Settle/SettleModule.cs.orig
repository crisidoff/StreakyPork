using System;
using System.IO;
using Autofac;
using Newtonsoft.Json;
using Whale.Settle.AliPay;
using Whale.Settle.Constants;
using Whale.Settle.Internal;
using Whale.Settle.JdPay;
using Whale.Settle.WeChat;

namespace Whale.Settle
{
    public class SettleModule : Module
    {
        private readonly SettleOptions _options;

        public SettleModule()
        {
<<<<<<< HEAD
            var basePath = AppDomain.CurrentDomain.BaseDirectory;
            if (!basePath.EndsWith("bin", StringComparison.CurrentCultureIgnoreCase))
            {
                basePath = $@"{basePath}\bin";
            }
            var json = File.ReadAllText($@"{basePath}\SettleOptions.json");
=======
            var json = File.ReadAllText( $"{AppDomain.CurrentDomain.BaseDirectory}/SettleOptions.json");
>>>>>>> 39825b3e31a2579c17129287386719d035fa5fba
            _options = JsonConvert.DeserializeObject<SettleOptions>(json);
        }

        protected override void Load(ContainerBuilder builder)
        {
            builder.Register(c => _options).SingleInstance();
            builder.RegisterType<SettleService>().As<ISettleService>().InstancePerLifetimeScope();
            builder.RegisterType<AlipayChannel>().Keyed<ISettleChannel>(Providers.Alipay).InstancePerLifetimeScope();
            builder.RegisterType<WeChatChannel>().Keyed<ISettleChannel>(Providers.WeChat).InstancePerLifetimeScope();
            builder.RegisterType<JdPayChannel>().Keyed<ISettleChannel>(Providers.JdPay).InstancePerLifetimeScope();
        }
    }
}